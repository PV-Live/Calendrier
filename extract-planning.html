<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6c5ce7">
    <title>Extraction Planning - Calendrier Leo</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/modern-styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="images/icons/icon-72x72.png">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">
    <!-- Polices -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <h1>MyMedICal</h1>
        <p>Extraction de Planning</p>
        <nav class="top-nav">
            <a href="index.html" class="nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Accueil
            </a>
            <a href="settings.html" class="nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                Paramètres
            </a>
        </nav>
    </header>

    <main>
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>Configuration</h2>
                </div>
                <div class="form-group">
                    <label for="apiKey">Clé API Mistral:</label>
                    <input type="text" id="apiKey" placeholder="Entrez votre clé API Mistral">
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>Télécharger une image</h2>
                </div>
                <div class="drop-area">
                    <p>Glissez-déposez une image ici ou</p>
                    <label for="imageInput" class="button button-primary">Parcourir</label>
                    <input type="file" id="imageInput" accept="image/*" hidden>
                </div>
                <div id="imagePreview" class="preview-container" style="display: none;"></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>Analyser l'image</h2>
                </div>
                <div class="button-group">
                    <button id="analyzeBtn" class="button button-primary">Analyser avec Mistral OCR</button>
                </div>
                <div class="loader" id="loader"></div>
            </div>
            
            <div class="card results-section" id="resultsSection" style="display: none;">
                <div class="card-header">
                    <h2>Résultats</h2>
                </div>
                <div class="tab-container">
                    <div class="tab">
                        <button class="tablinks active" onclick="openTab(event, 'rawTab')">Texte brut</button>
                        <button class="tablinks" onclick="openTab(event, 'tableTab')">Tableau</button>
                        <button class="tablinks" onclick="openTab(event, 'codesTab')">Codes</button>
                    </div>
                    
                    <div id="rawTab" class="tabcontent" style="display: block;">
                        <h3>Texte OCR brut</h3>
                        <div class="result" id="rawResult"></div>
                    </div>
                    
                    <div id="tableTab" class="tabcontent">
                        <h3>Tableau extrait</h3>
                        <div id="tableResult"></div>
                    </div>
                    
                    <div id="codesTab" class="tabcontent">
                        <h3>Codes par personne</h3>
                        <div class="form-group">
                            <label for="personSelect">Sélectionner une personne:</label>
                            <select id="personSelect" class="name-select"></select>
                        </div>
                        <div id="personCodes" class="codes-container"></div>
                        <div id="personCodesTable"></div>
                        
                        <div class="add-code-form">
                            <h4>Ajouter un code</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="dayInput">Jour:</label>
                                    <input type="number" id="dayInput" min="1" max="31" placeholder="Jour">
                                </div>
                                <div class="form-group">
                                    <label for="codeInput">Code:</label>
                                    <input type="text" id="codeInput" placeholder="Code">
                                </div>
                                <button id="addCodeBtn" class="button button-primary">Ajouter</button>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button id="exportIcsBtn" class="button button-primary">Exporter en ICS</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; <span id="currentYear"></span> MyMedICal - Tous droits réservés</p>
    </footer>

    <div class="toast" id="toast" hidden>
        <p id="toastMessage"></p>
    </div>

    <script>
        // Mettre à jour l'année dans le footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        
        // Variables globales
        let ocrData = null;
        let personData = {};
        
        // Gestionnaires d'événements
        document.getElementById('imageInput').addEventListener('change', handleImageSelect);
        document.getElementById('analyzeBtn').addEventListener('click', analyzeImage);
        document.getElementById('personSelect').addEventListener('change', displayPersonCodes);
        document.getElementById('addCodeBtn').addEventListener('click', function() {
            const day = document.getElementById('dayInput').value;
            const code = document.getElementById('codeInput').value;
            if (day && code) {
                const personName = document.getElementById('personSelect').value;
                if (!personData[personName]) {
                    personData[personName] = {};
                }
                personData[personName][day] = code;
                displayPersonCodes();
                document.getElementById('dayInput').value = '';
                document.getElementById('codeInput').value = '';
            }
        });
        document.getElementById('exportIcsBtn').addEventListener('click', function() {
            const personName = document.getElementById('personSelect').value;
            if (personName && personData[personName]) {
                exportToICS({name: personName, codes: personData[personName]});
            }
        });
        
        /**
         * Gère la sélection d'une image
         */
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '100%';
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = '';
                    preview.appendChild(img);
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        /**
         * Analyse l'image avec Mistral OCR
         */
        function analyzeImage() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                updateStatus('Veuillez entrer une clé API Mistral', 'error');
                return;
            }
            
            const fileInput = document.getElementById('imageInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                updateStatus('Veuillez sélectionner une image', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            
            updateStatus('Analyse en cours...', 'info');
            
            // Convertir l'image en base64
            convertImageToBase64(file)
                .then(base64Image => {
                    // Appel à l'API Mistral OCR
                    fetch('https://api.mistral.ai/v1/vision', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'mistral-large-latest',
                            messages: [
                                {
                                    role: 'user',
                                    content: [
                                        {
                                            type: 'text',
                                            text: 'Analyse cette image qui contient un tableau de planning. Extrait le texte complet et formate-le en markdown.'
                                        },
                                        {
                                            type: 'image_url',
                                            image_url: {
                                                url: base64Image
                                            }
                                        }
                                    ]
                                }
                            ]
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        loader.style.display = 'none';
                        
                        if (data.error) {
                            updateStatus(`Erreur: ${data.error.message}`, 'error');
                            return;
                        }
                        
                        const markdownText = data.choices[0].message.content;
                        document.getElementById('rawResult').textContent = markdownText;
                        document.getElementById('resultsSection').style.display = 'block';
                        
                        // Traiter le tableau Markdown
                        const tableData = processMarkdownTable(markdownText);
                        if (tableData) {
                            displayTable(tableData);
                            updatePersonSelect(tableData);
                            ocrData = tableData;
                            updateStatus('Analyse terminée avec succès', 'success');
                        } else {
                            updateStatus('Impossible d\'extraire un tableau du texte', 'warning');
                        }
                    })
                    .catch(error => {
                        loader.style.display = 'none';
                        updateStatus(`Erreur: ${error.message}`, 'error');
                    });
                });
        }
        
        /**
         * Traite un tableau Markdown pour en extraire les données structurées
         */
        function processMarkdownTable(markdownText) {
            // Rechercher le tableau dans le texte markdown
            const tableRegex = /\|(.+)\|[\r\n]+\|([-:| ]+)\|[\r\n]+([\s\S]+?)(?:\n\n|$)/g;
            const tableMatch = tableRegex.exec(markdownText);
            
            if (!tableMatch) return null;
            
            // Extraire les en-têtes
            const headerLine = tableMatch[1];
            const headers = headerLine.split('|').map(h => h.trim()).filter(h => h);
            
            // Extraire les lignes de données
            const dataLines = tableMatch[3].split('\n');
            const data = [];
            
            for (const line of dataLines) {
                if (!line.includes('|')) continue;
                
                const cells = line.split('|').map(c => c.trim()).filter(c => c);
                if (cells.length === 0) continue;
                
                const rowData = {};
                for (let i = 0; i < Math.min(headers.length, cells.length); i++) {
                    rowData[headers[i]] = cells[i];
                }
                
                // Extraire le nom de la personne (première colonne)
                const personName = cells[0];
                if (personName) {
                    rowData.name = personName;
                    
                    // Extraire les codes (colonnes suivantes)
                    const codes = {};
                    for (let i = 1; i < Math.min(headers.length, cells.length); i++) {
                        const day = headers[i];
                        const code = cells[i].replace(/\*\*/g, '').trim(); // Supprimer les ** pour le gras
                        if (code && code !== '-') {
                            codes[day] = code;
                        }
                    }
                    rowData.codes = codes;
                    
                    data.push(rowData);
                }
            }
            
            return data;
        }
        
        /**
         * Affiche les données du tableau dans un tableau HTML
         */
        function displayTable(data) {
            const tableResult = document.getElementById('tableResult');
            
            if (!data || data.length === 0) {
                tableResult.innerHTML = '<p>Aucune donnée à afficher</p>';
                return;
            }
            
            // Créer le tableau
            const table = document.createElement('table');
            table.className = 'results-table';
            
            // Créer l'en-tête
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // Ajouter la colonne pour les noms
            const nameHeader = document.createElement('th');
            nameHeader.textContent = 'Nom';
            headerRow.appendChild(nameHeader);
            
            // Ajouter les colonnes pour les jours
            const firstPerson = data[0];
            const days = Object.keys(firstPerson.codes);
            
            for (const day of days) {
                const dayHeader = document.createElement('th');
                dayHeader.textContent = day;
                headerRow.appendChild(dayHeader);
            }
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Créer le corps du tableau
            const tbody = document.createElement('tbody');
            
            for (const person of data) {
                const row = document.createElement('tr');
                
                // Ajouter la cellule pour le nom
                const nameCell = document.createElement('td');
                nameCell.textContent = person.name;
                row.appendChild(nameCell);
                
                // Ajouter les cellules pour les codes
                for (const day of days) {
                    const codeCell = document.createElement('td');
                    const code = person.codes[day] || '-';
                    
                    if (code !== '-') {
                        const codeSpan = document.createElement('span');
                        codeSpan.className = 'code-cell';
                        codeSpan.textContent = code;
                        codeCell.appendChild(codeSpan);
                    } else {
                        codeCell.textContent = '-';
                    }
                    
                    row.appendChild(codeCell);
                }
                
                tbody.appendChild(row);
            }
            
            table.appendChild(tbody);
            tableResult.innerHTML = '';
            tableResult.appendChild(table);
        }
        
        /**
         * Met à jour la liste déroulante des personnes
         */
        function updatePersonSelect(data) {
            const personSelect = document.getElementById('personSelect');
            personSelect.innerHTML = '';
            
            if (!data || data.length === 0) {
                return;
            }
            
            for (const person of data) {
                const option = document.createElement('option');
                option.value = person.name;
                option.textContent = person.name;
                personSelect.appendChild(option);
                
                // Stocker les données de cette personne
                personData[person.name] = person.codes;
            }
            
            // Afficher les codes pour la première personne
            displayPersonCodes();
        }
        
        /**
         * Affiche les codes pour la personne sélectionnée
         */
        function displayPersonCodes() {
            const personSelect = document.getElementById('personSelect');
            const personName = personSelect.value;
            const codesContainer = document.getElementById('personCodes');
            const codesTableContainer = document.getElementById('personCodesTable');
            
            if (!personName || !personData[personName]) {
                codesContainer.innerHTML = '<p>Aucun code disponible</p>';
                codesTableContainer.innerHTML = '';
                return;
            }
            
            const codes = personData[personName];
            
            // Afficher les badges de code
            codesContainer.innerHTML = '';
            for (const day in codes) {
                const codeBadge = document.createElement('div');
                codeBadge.className = 'code-badge';
                codeBadge.textContent = `${day}: ${codes[day]}`;
                codesContainer.appendChild(codeBadge);
            }
            
            // Créer le tableau des codes
            const table = document.createElement('table');
            table.className = 'codes-table';
            
            // En-tête du tableau
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const dayHeader = document.createElement('th');
            dayHeader.textContent = 'Jour';
            headerRow.appendChild(dayHeader);
            
            const codeHeader = document.createElement('th');
            codeHeader.textContent = 'Code';
            headerRow.appendChild(codeHeader);
            
            const actionHeader = document.createElement('th');
            actionHeader.textContent = 'Action';
            headerRow.appendChild(actionHeader);
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Corps du tableau
            const tbody = document.createElement('tbody');
            
            // Trier les jours numériquement
            const sortedDays = Object.keys(codes).sort((a, b) => parseInt(a) - parseInt(b));
            
            for (const day of sortedDays) {
                const row = document.createElement('tr');
                
                const dayCell = document.createElement('td');
                dayCell.textContent = day;
                row.appendChild(dayCell);
                
                const codeCell = document.createElement('td');
                const codeSpan = document.createElement('span');
                codeSpan.className = 'code-cell';
                codeSpan.textContent = codes[day];
                codeCell.appendChild(codeSpan);
                row.appendChild(codeCell);
                
                const actionCell = document.createElement('td');
                const deleteButton = document.createElement('button');
                deleteButton.className = 'button button-secondary';
                deleteButton.textContent = 'Supprimer';
                deleteButton.onclick = function() {
                    delete codes[day];
                    displayPersonCodes();
                };
                actionCell.appendChild(deleteButton);
                row.appendChild(actionCell);
                
                tbody.appendChild(row);
            }
            
            table.appendChild(tbody);
            codesTableContainer.innerHTML = '';
            codesTableContainer.appendChild(table);
        }
        
        /**
         * Exporte les codes d'une personne au format ICS
         * @param {Object} person - Personne dont les codes doivent être exportés
         */
        function exportToICS(person) {
            if (!person || !person.codes || Object.keys(person.codes).length === 0) {
                updateStatus('Aucun code à exporter', 'warning');
                return;
            }
            
            const now = new Date();
            const year = parseInt(now.getFullYear());
            const month = parseInt(now.getMonth()) + 1; // Les mois commencent à 0
            
            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//MyMedICal//Planning Exporter//FR',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH'
            ];
            
            // Créer un événement pour chaque code
            for (const day in person.codes) {
                const code = person.codes[day];
                const startDate = new Date(year, month - 1, parseInt(day));
                const endDate = new Date(year, month - 1, parseInt(day) + 1);
                
                // Formater les dates pour ICS (format: YYYYMMDDTHHMMSSZ)
                const startDateStr = startDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const endDateStr = endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                
                // Créer l'événement
                icsContent = icsContent.concat([
                    'BEGIN:VEVENT',
                    `UID:${Math.random().toString(36).substring(2, 15)}@mymedical.app`,
                    `DTSTAMP:${now.toISOString().replace(/[-:]/g, '').split('.')[0]}Z`,
                    `DTSTART:${startDateStr}`,
                    `DTEND:${endDateStr}`,
                    `SUMMARY:${code}`,
                    `DESCRIPTION:Code ${code} pour ${person.name}`,
                    'END:VEVENT'
                ]);
            }
            
            icsContent.push('END:VCALENDAR');
            
            // Créer le fichier ICS
            const blob = new Blob([icsContent.join('\r\n')], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            // Télécharger le fichier
            const a = document.createElement('a');
            a.href = url;
            a.download = `planning_${person.name.replace(/\s+/g, '_')}_${year}_${month}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            updateStatus('Exportation ICS réussie', 'success');
        }
        
        /**
         * Convertit une image en base64
         */
        function convertImageToBase64(imageFile) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = event => {
                    resolve(event.target.result);
                };
                reader.onerror = error => {
                    reject(error);
                };
                reader.readAsDataURL(imageFile);
            });
        }
        
        /**
         * Met à jour le statut de l'analyse
         */
        function updateStatus(message, type) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type || 'info'}`;
            toast.hidden = false;
            
            setTimeout(() => {
                toast.hidden = true;
            }, 3000);
        }
        
        /**
         * Ouvre un onglet
         */
        function openTab(evt, tabName) {
            // Masquer tous les contenus d'onglets
            const tabcontent = document.getElementsByClassName('tabcontent');
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = 'none';
            }
            
            // Supprimer la classe "active" de tous les boutons d'onglets
            const tablinks = document.getElementsByClassName('tablinks');
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(' active', '');
            }
            
            // Afficher l'onglet actuel et ajouter la classe "active" au bouton
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.className += ' active';
        }
    </script>
</body>
</html>
